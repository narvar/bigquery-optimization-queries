{
  "configuration": {
    "jobType": "QUERY",
    "query": {
      "priority": "INTERACTIVE",
      "query": "\n        -- Create temp table with changed items using the persisted updates table\n        CREATE OR REPLACE TABLE `narvar-data-lake.return_insights_base.tmp_product_insights_updates_2025-11-20` AS (\n            WITH affected_items AS (\n                -- Get unique item identifiers from the updates table\n                SELECT DISTINCT\n                    retailer_moniker,\n                    shopify_domain,\n                    order_date,\n                    order_checkout_locale,\n                    order_item_product_id,\n                    order_item_description,\n                    order_item_name,\n                    order_item_sku,\n                    order_item_vendor,\n                    order_item_size,\n                    order_item_color,\n                    order_item_product_type,\n                    order_item_variant_id,\n                    order_item_variant_title, \n                    return_outcome\n                FROM `narvar-data-lake.return_insights_base.tmp_order_item_details_2025-11-20`\n            )\n            -- Reaggregate all records for the affected items\n            SELECT\n                r.retailer_moniker,\n                r.shopify_domain,\n                DATE(r.order_date) AS order_date,\n                r.order_checkout_locale,\n                r.order_item_product_id,\n                r.order_item_description,\n                r.order_item_name,\n                r.order_item_sku,\n                r.order_item_vendor,\n                r.order_item_size,\n                r.order_item_color,\n                r.order_item_product_type,\n                r.order_item_variant_id,\n                r.order_item_variant_title,\n                r.return_outcome,\n                \n                `narvar-data-lake.return_insights_base.histogram`(ARRAY_AGG(r.item_return_reason IGNORE NULLS LIMIT 10)) AS return_reason_summary,\n                `narvar-data-lake.return_insights_base.histogram`(ARRAY_AGG(r.item_child_return_reason IGNORE NULLS LIMIT 10)) AS child_return_reason_summary,\n                `narvar-data-lake.return_insights_base.histogram`(ARRAY_AGG(r.return_method_id IGNORE NULLS LIMIT 10)) AS return_method_summary,\n\n                COUNT(DISTINCT r.cdp_pii_hash) AS num_customers,\n                COUNT(DISTINCT r.order_number) AS num_orders,\n                COUNT(DISTINCT r.return_order_number) AS num_return_orders,\n                COUNT(DISTINCT r.rma_number) AS num_rmas,\n                COUNT(DISTINCT IF(r.return_outcome = 'Refund to Original Payment', r.rma_number, NULL)) AS num_refunds,\n                COUNT(DISTINCT IF(r.return_outcome = 'Exchanges & Shop Now', r.rma_number, NULL)) AS num_exchanges,\n                COUNT(DISTINCT IF(r.return_outcome = 'Gift Cards', r.rma_number, NULL)) AS num_gift_cards,\n                COUNT(DISTINCT IF(r.is_shop_now_return, r.rma_number, NULL)) AS num_shop_now_returns,\n                SUM(GREATEST(r.order_item_quantity, r.order_shipped_item_quantity)) AS num_order_items,\n                SUM(r.return_item_quantity) AS num_return_items,\n                SUM(if(r.return_outcome = 'Refund to Original Payment', r.return_item_quantity, 0)) AS num_refund_items,\n                SUM(if(r.return_outcome = 'Exchanges & Shop Now', r.return_item_quantity, 0)) AS num_exchange_items,\n                SUM(r.order_item_price * GREATEST(r.order_item_quantity, r.order_shipped_item_quantity) * COALESCE(r.conversion_rate_order_to_shop, 1)) AS total_order_value_shop_currency,\n                SUM(r.return_value_cents_shop_currency) / 100 AS total_return_value_shop_currency,\n                SUM(r.exchange_from_value_cents_shop_currency) / 100 AS total_exchange_from_value_shop_currency,\n                SUM(r.exchange_to_value_cents_shop_currency) / 100 AS total_exchange_to_value_shop_currency,\n                SUM(r.shop_now_exchange_value_shop_currency) / 100 AS total_shop_now_exchange_value_shop_currency,\n                SUM(IF(r.return_outcome = 'Refund to Original Payment', r.return_value_cents_shop_currency, 0)) / 100 AS total_refund_value_shop_currency,\n                SUM(IF(r.return_outcome = 'Gift Cards', r.return_value_cents_shop_currency, 0)) / 100 AS total_gift_card_value_shop_currency,\n                CURRENT_TIMESTAMP() as modified_at,\n                FARM_FINGERPRINT(CONCAT(\n                    COALESCE(r.retailer_moniker, ''),\n                    COALESCE(r.shopify_domain, ''),\n                    COALESCE(SAFE_CAST(DATE(r.order_date) AS STRING), ''),\n                    COALESCE(r.order_checkout_locale, ''),\n                    COALESCE(r.order_item_product_id, ''),\n                    COALESCE(r.order_item_description, ''),\n                    COALESCE(r.order_item_name, ''),\n                    COALESCE(r.order_item_sku, ''),\n                    COALESCE(r.order_item_vendor, ''),\n                    COALESCE(r.order_item_size, ''),\n                    COALESCE(r.order_item_color, ''),\n                    COALESCE(r.order_item_product_type, ''),\n                    COALESCE(r.return_outcome, ''),\n                    COALESCE(r.order_item_variant_id, ''),\n                    COALESCE(r.order_item_variant_title, '')\n                )) AS primary_key_hash\n            FROM `narvar-data-lake.return_insights_base.order_item_details` r\n            INNER JOIN affected_items a\n                ON r.retailer_moniker = a.retailer_moniker\n                AND r.shopify_domain = a.shopify_domain\n                AND DATE(r.order_date) = DATE(a.order_date)\n                AND r.order_item_sku = a.order_item_sku\n            GROUP BY\n                r.retailer_moniker,\n                r.shopify_domain,\n                DATE(r.order_date),\n                r.order_checkout_locale,\n                r.order_item_product_id,\n                r.order_item_description,\n                r.order_item_name,\n                r.order_item_sku,\n                r.order_item_vendor,\n                r.order_item_size,\n                r.order_item_color,\n                r.order_item_product_type,\n                r.return_outcome,\n                r.order_item_variant_id,\n                r.order_item_variant_title,\n                primary_key_hash\n        );\n\n        -- Merge changes into the summary table\n        MERGE `narvar-data-lake.return_insights_base.product_insights` T\n        USING `narvar-data-lake.return_insights_base.tmp_product_insights_updates_2025-11-20` S\n        ON T.retailer_moniker = S.retailer_moniker\n           AND T.primary_key_hash = S.primary_key_hash\n        WHEN MATCHED THEN\n            UPDATE SET\n                retailer_moniker = S.retailer_moniker,order_date = S.order_date,order_checkout_locale = S.order_checkout_locale,order_item_product_id = S.order_item_product_id,order_item_description = S.order_item_description,order_item_name = S.order_item_name,order_item_sku = S.order_item_sku,order_item_vendor = S.order_item_vendor,order_item_size = S.order_item_size,order_item_color = S.order_item_color,order_item_product_type = S.order_item_product_type,order_item_variant_id = S.order_item_variant_id,order_item_variant_title = S.order_item_variant_title,return_reason_summary = S.return_reason_summary,child_return_reason_summary = S.child_return_reason_summary,return_method_summary = S.return_method_summary,num_customers = S.num_customers,num_orders = S.num_orders,num_return_orders = S.num_return_orders,num_rmas = S.num_rmas,num_refunds = S.num_refunds,num_exchanges = S.num_exchanges,num_gift_cards = S.num_gift_cards,num_shop_now_returns = S.num_shop_now_returns,num_order_items = S.num_order_items,num_return_items = S.num_return_items,num_refund_items = S.num_refund_items,num_exchange_items = S.num_exchange_items,total_order_value_shop_currency = S.total_order_value_shop_currency,total_return_value_shop_currency = S.total_return_value_shop_currency,total_exchange_from_value_shop_currency = S.total_exchange_from_value_shop_currency,total_exchange_to_value_shop_currency = S.total_exchange_to_value_shop_currency,total_shop_now_exchange_value_shop_currency = S.total_shop_now_exchange_value_shop_currency,total_refund_value_shop_currency = S.total_refund_value_shop_currency,total_gift_card_value_shop_currency = S.total_gift_card_value_shop_currency,modified_at = S.modified_at,primary_key_hash = S.primary_key_hash\n        WHEN NOT MATCHED THEN\n            INSERT (retailer_moniker,order_date,order_checkout_locale,order_item_product_id,order_item_description,order_item_name,order_item_sku,order_item_vendor,order_item_size,order_item_color,order_item_product_type,order_item_variant_id,order_item_variant_title,return_reason_summary,child_return_reason_summary,return_method_summary,num_customers,num_orders,num_return_orders,num_rmas,num_refunds,num_exchanges,num_gift_cards,num_shop_now_returns,num_order_items,num_return_items,num_refund_items,num_exchange_items,total_order_value_shop_currency,total_return_value_shop_currency,total_exchange_from_value_shop_currency,total_exchange_to_value_shop_currency,total_shop_now_exchange_value_shop_currency,total_refund_value_shop_currency,total_gift_card_value_shop_currency,modified_at,primary_key_hash)\n            VALUES (S.retailer_moniker,S.order_date,S.order_checkout_locale,S.order_item_product_id,S.order_item_description,S.order_item_name,S.order_item_sku,S.order_item_vendor,S.order_item_size,S.order_item_color,S.order_item_product_type,S.order_item_variant_id,S.order_item_variant_title,S.return_reason_summary,S.child_return_reason_summary,S.return_method_summary,S.num_customers,S.num_orders,S.num_return_orders,S.num_rmas,S.num_refunds,S.num_exchanges,S.num_gift_cards,S.num_shop_now_returns,S.num_order_items,S.num_return_items,S.num_refund_items,S.num_exchange_items,S.total_order_value_shop_currency,S.total_return_value_shop_currency,S.total_exchange_from_value_shop_currency,S.total_exchange_to_value_shop_currency,S.total_shop_now_exchange_value_shop_currency,S.total_refund_value_shop_currency,S.total_gift_card_value_shop_currency,S.modified_at,S.primary_key_hash);\n    ",
      "useLegacySql": false
    }
  },
  "etag": "4SReiqKXlDb2yf0YisqMRw==",
  "id": "narvar-data-lake:US.job_GfBO-8zBmqLqbOcAErnuRkaa0LQO",
  "jobCreationReason": {
    "code": "REQUESTED"
  },
  "jobReference": {
    "jobId": "job_GfBO-8zBmqLqbOcAErnuRkaa0LQO",
    "location": "US",
    "projectId": "narvar-data-lake"
  },
  "kind": "bigquery#job",
  "principal_subject": "serviceAccount:airflow-bq-job-user-2@narvar-data-lake.iam.gserviceaccount.com",
  "selfLink": "https://bigquery.googleapis.com/bigquery/v2/projects/narvar-data-lake/jobs/job_GfBO-8zBmqLqbOcAErnuRkaa0LQO?location=US",
  "statistics": {
    "creationTime": "1763707110087",
    "endTime": "1763728710661",
    "numChildJobs": "1",
    "query": {
      "statementType": "SCRIPT",
      "totalBytesBilled": "0",
      "totalBytesProcessed": "0",
      "totalSlotMs": "309102626"
    },
    "startTime": "1763707110124",
    "totalBytesProcessed": "0",
    "totalSlotMs": "309102626"
  },
  "status": {
    "errorResult": {
      "location": "query",
      "message": "Request timed out. Please try again. at [3:9]",
      "reason": "timeout"
    },
    "state": "DONE"
  },
  "user_email": "airflow-bq-job-user-2@narvar-data-lake.iam.gserviceaccount.com"
}
