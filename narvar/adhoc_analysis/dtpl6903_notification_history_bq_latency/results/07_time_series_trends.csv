WITH daily_metrics AS (
  SELECT
    DATE(creation_time) AS query_date,
    EXTRACT(DAYOFWEEK FROM creation_time) AS day_of_week,
    EXTRACT(HOUR FROM creation_time) AS hour,
    
    COUNT(*) AS query_count,
    
    -- Queue time metrics
    AVG(TIMESTAMP_DIFF(start_time, creation_time, SECOND)) AS avg_queue_seconds,
    APPROX_QUANTILES(TIMESTAMP_DIFF(start_time, creation_time, SECOND), 100)[OFFSET(50)] AS p50_queue_seconds,
    APPROX_QUANTILES(TIMESTAMP_DIFF(start_time, creation_time, SECOND), 100)[OFFSET(90)] AS p90_queue_seconds,
    APPROX_QUANTILES(TIMESTAMP_DIFF(start_time, creation_time, SECOND), 100)[OFFSET(95)] AS p95_queue_seconds,
    MAX(TIMESTAMP_DIFF(start_time, creation_time, SECOND)) AS max_queue_seconds,
    
    -- Execution time
    AVG(TIMESTAMP_DIFF(end_time, start_time, SECOND)) AS avg_execution_seconds,
    
    -- Resource consumption
    SUM(total_slot_ms) / 1000 AS total_slot_seconds,
    SUM(total_bytes_processed) / POW(1024, 3) AS total_gb_processed,
    
    -- Problem indicators
    COUNTIF(TIMESTAMP_DIFF(start_time, creation_time, SECOND) > 60) AS queries_delayed_over_1min,
    COUNTIF(TIMESTAMP_DIFF(start_time, creation_time, SECOND) > 300) AS queries_delayed_over_5min
    
  FROM `region-us`.INFORMATION_SCHEMA.JOBS_BY_PROJECT
  WHERE creation_time BETWEEN analysis_start_date AND analysis_end_date
    AND user_email = target_user
    AND job_type = 'QUERY'
    AND state = 'DONE'
  GROUP BY query_date, day_of_week, hour
)

SELECT
  query_date,
  CASE day_of_week
    WHEN 1 THEN 'Sunday'
    WHEN 2 THEN 'Monday'
    WHEN 3 THEN 'Tuesday'
    WHEN 4 THEN 'Wednesday'
    WHEN 5 THEN 'Thursday'
    WHEN 6 THEN 'Friday'
    WHEN 7 THEN 'Saturday'
  END AS day_name,
  
  -- Aggregate to day level
  SUM(query_count) AS daily_queries,
  
  -- Queue time statistics
  ROUND(AVG(avg_queue_seconds), 1) AS avg_queue_sec,
  MAX(p50_queue_seconds) AS worst_p50_queue_sec,
  MAX(p90_queue_seconds) AS worst_p90_queue_sec,
  MAX(p95_queue_seconds) AS worst_p95_queue_sec,
  MAX(max_queue_seconds) AS worst_delay_sec,
  
  -- Execution time
  ROUND(AVG(avg_execution_seconds), 1) AS avg_exec_sec,
  
  -- Resource totals
  ROUND(SUM(total_slot_seconds), 0) AS total_slot_sec,
  ROUND(SUM(total_gb_processed), 1) AS total_gb,
  
  -- Problem severity indicators
  SUM(queries_delayed_over_1min) AS delayed_over_1min,
  SUM(queries_delayed_over_5min) AS delayed_over_5min,
  ROUND(100.0 * SUM(queries_delayed_over_1min) / SUM(query_count), 1) AS pct_delayed,
  
  -- Peak hours
  STRING_AGG(
    CAST(hour AS STRING), ', ' ORDER BY hour
  ) AS active_hours

FROM daily_metrics
GROUP BY query_date, day_of_week, day_name
ORDER BY query_date DESC; -- at [16:1]
query_date,day_name,daily_queries,avg_queue_sec,worst_p50_queue_sec,worst_p90_queue_sec,worst_p95_queue_sec,worst_delay_sec,avg_exec_sec,total_slot_sec,total_gb,delayed_over_1min,delayed_over_5min,pct_delayed,active_hours
2025-11-21,Friday,9674,14.7,176,507,508,558,3.9,2626934.0,111023.9,249,32,2.6,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19"
2025-11-20,Thursday,14654,2.4,21,188,322,476,3.2,3196650.0,146291.8,177,59,1.2,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-19,Wednesday,14104,0.7,0,24,73,371,5.6,3653959.0,171987.4,40,13,0.3,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-18,Tuesday,12912,1.5,0,180,180,180,9.7,5453651.0,202319.3,23,0,0.2,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-17,Monday,14214,0.0,0,0,0,1,4.3,4870028.0,178922.0,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-16,Sunday,9003,0.0,0,0,0,11,3.1,5316933.0,157897.3,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-15,Saturday,9295,0.0,0,0,0,2,2.2,3323579.0,99455.7,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-14,Friday,11674,3.4,28,194,209,212,3.3,3135757.0,118950.7,85,0,0.7,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-13,Thursday,12927,0.1,0,1,7,61,5.0,3255969.0,129271.5,5,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-12,Wednesday,15931,0.0,0,0,0,3,2.4,3674738.0,153219.8,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-11,Tuesday,14704,0.0,0,0,0,3,2.5,3163803.0,141332.2,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-10,Monday,14075,0.0,0,0,0,1,1.5,2387636.0,150390.4,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-09,Sunday,7702,0.0,0,0,0,0,1.7,2525736.0,85998.5,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-08,Saturday,8976,0.0,0,0,0,1,4.4,2419668.0,84722.8,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-07,Friday,8705,0.0,0,0,0,0,2.6,3391518.0,92932.1,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-06,Thursday,13234,0.0,0,2,6,44,2.4,2976066.0,159744.5,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-05,Wednesday,12759,0.1,0,1,5,97,2.0,2880214.0,103848.6,9,0,0.1,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-04,Tuesday,13243,0.0,0,0,0,1,2.6,2803107.0,109009.0,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-03,Monday,13980,0.0,0,0,0,1,1.9,2367993.0,108289.4,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-02,Sunday,6897,0.0,0,0,0,0,2.2,2217586.0,66259.6,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-11-01,Saturday,7840,0.0,0,0,0,0,2.0,2707246.0,79124.3,0,0,0.0,"0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23"
2025-10-31,Friday,3269,0.0,0,0,0,1,0.8,393501.0,14309.3,0,0,0.0,"19, 20, 21, 22, 23"
